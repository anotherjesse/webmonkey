<!doctype html public "-//W3C//DTD HTML 4.0 Frameset//EN""http://www.w3.org/TR/REC-html40/frameset.dtd">
<html>
<head>
<title>
Webmonkey Overview
</title>
<link rel ="stylesheet" type="text/css" href="stylesheet.css" title="Style">
<script>
function asd() {
	
		parent.document.title="browser.js Overview";
	
}
</script>
</head>
<body bgcolor="white" onload="asd();">

<!-- ========== START OF NAVBAR ========== -->
<a name="navbar_top"><!-- --></a>
<table border="0" width="100%" cellpadding="1" cellspacing="0">
<tr>
<td colspan=2 bgcolor="#EEEEFF" class="NavBarCell1">
<a name="navbar_top_firstrow"><!-- --></a>
<table border="0" cellpadding="0" cellspacing="3">
  <tr align="center" valign="top">
  
  
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-summary.html"><font class="NavBarFont1"><b>Overview</b></font></a>&nbsp;</td>
  <td bgcolor="#FFFFFF" class="NavBarCell1Rev">	&nbsp;<font class="NavBarFont1Rev"><b>File</b></font>&nbsp;</td>
  

  <td bgcolor="#FFFFFF" class="NavBarCell1"> 	<font class="NavBarFont1">Class</font>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-tree.html"><font class="NavBarFont1"><b>Tree</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="index-all.html"--><font class="NavBarFont1"><b>Index</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="help-doc.html"><font class="NavBarFont1"><b>Help</b></font></a>&nbsp;</td>
  </tr>
</table>
</td>
<td bgcolor="#EEEEFF" align="right" valign="top">
<em>
<b>Webmonkey</b></em>
</td>
</tr>

<tr>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
&nbsp;PREV&nbsp;
&nbsp;NEXT</font></td>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
  <a href="index.html" target="_top"><b>FRAMES</b></a>  &nbsp;
&nbsp;<a href="overview-summary.html" target="_top"><b>NO FRAMES</b></a>
&nbsp;&nbsp;
<script>
  <!--
  if(window==top) {
    document.writeln('<A HREF="allclasses-noframe.html" TARGET=""><B>All Classes</B></A>');
  }
  //-->
</script>
<noscript>
<a href="allclasses-noframe.html" target=""><b>All Classes</b></a>
</noscript>
</font></td>
</tr>
</table>
<!-- =========== END OF NAVBAR =========== -->

<hr>
<center>
	
	   <h2>browser.js</h2>
	
</center>

	


<h4>Summary</h4>
<p>
	
		No overview generated for 'browser.js'<BR/><BR/>
	
</p>

<hr>



<!-- ========== METHOD SUMMARY =========== -->

	<a name="method_summary"><!-- --></a>
	<table border="1" cellpadding="3" cellspacing="0" width="100%">
		<tr bgcolor="#CCCCFF" class="TableHeadingColor">
			<td colspan=2>
				<font size="+2">
					<b>Method Summary</b>
				</font>
			</td>
		</tr>
	
		
		   <tr bgcolor="white" class="TableRowColor">
		      <td align="right" valign="top" width="1%">
			 <font size="-1">
			    <code>static&nbsp;void</code>
			 </font>
		      </td>
		      <td>
			 <code>
			    <b>
			       <a href="GLOBALS.html#!s!GM_popupClicked">GM_popupClicked</a></b>(aEvent)
			 </code>
			 <br>
			 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
			 Handle clicking one of the items in the popup.
		      </td>
		   </tr>
		
		   <tr bgcolor="white" class="TableRowColor">
		      <td align="right" valign="top" width="1%">
			 <font size="-1">
			    <code>static&nbsp;void</code>
			 </font>
		      </td>
		      <td>
			 <code>
			    <b>
			       <a href="GLOBALS.html#!s!GM_showGeneralPopup">GM_showGeneralPopup</a></b>(aEvent)
			 </code>
			 <br>
			 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
			 
		      </td>
		   </tr>
		
		   <tr bgcolor="white" class="TableRowColor">
		      <td align="right" valign="top" width="1%">
			 <font size="-1">
			    <code>static&nbsp;void</code>
			 </font>
		      </td>
		      <td>
			 <code>
			    <b>
			       <a href="GLOBALS.html#!s!GM_showPopup">GM_showPopup</a></b>(aEvent)
			 </code>
			 <br>
			 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
			 
		      </td>
		   </tr>
		
	
	</table>
    <p>

<!-- ========== END METHOD SUMMARY =========== -->


        <pre class="sourceview"><span class="comment">// this file is the JavaScript backing for the UI wrangling which happens in</span>
<span class="comment">// browser.xul. It also initializes the Greasemonkey singleton which contains</span>
<span class="comment">// all the main injection logic, though that should probably be a proper XPCOM</span>
<span class="comment">// service and wouldn't need to be initialized in that case.</span>

var GM_BrowserUI = new Object();

<span class="comment">/**
 * nsISupports.QueryInterface
 */</span>
GM_BrowserUI.QueryInterface = <span class="reserved">function</span>(aIID) {
  <span class="reserved">if</span> (!aIID.equals(Components.interfaces.nsISupports) &amp;&amp;
      !aIID.equals(Components.interfaces.nsISupportsWeakReference) &amp;&amp;
      !aIID.equals(Components.interfaces.nsIWebProgressListener))
    throw Components.results.NS_ERROR_NO_INTERFACE;

  <span class="reserved">return</span> <span class="reserved">this</span>;
};


<span class="comment">/**
 * Called when this file is parsed, by the last line. Set up initial objects,
 * do version checking, and set up listeners for browser xul load and location
 * changes.
 */</span>
GM_BrowserUI.init = <span class="reserved">function</span>() {
  <span class="reserved">this</span>.menuCommanders = [];
  <span class="reserved">this</span>.currentMenuCommander = null;

  GM_listen(window, <span class="literal">"load"</span>, GM_hitch(<span class="reserved">this</span>, <span class="literal">"chromeLoad"</span>));
  GM_listen(window, <span class="literal">"unload"</span>, GM_hitch(<span class="reserved">this</span>, <span class="literal">"chromeUnload"</span>));
};

<span class="comment">/**
 * The browser XUL has loaded. Find the elements we need and set up our
 * listeners and wrapper objects.
 */</span>
GM_BrowserUI.chromeLoad = <span class="reserved">function</span>(e) {
  <span class="comment">// get all required DOM elements</span>
  <span class="reserved">this</span>.tabBrowser = document.getElementById(<span class="literal">"content"</span>);
  <span class="reserved">this</span>.appContent = document.getElementById(<span class="literal">"appcontent"</span>);
  <span class="reserved">this</span>.contextMenu = document.getElementById(<span class="literal">"contentAreaContextMenu"</span>);
  <span class="reserved">this</span>.statusImage = document.getElementById(<span class="literal">"gm-status-image"</span>);
  <span class="reserved">this</span>.statusLabel = document.getElementById(<span class="literal">"gm-status-label"</span>);
  <span class="reserved">this</span>.statusPopup = document.getElementById(<span class="literal">"gm-status-popup"</span>);
  <span class="reserved">this</span>.statusEnabledItem = document.getElementById(<span class="literal">"gm-status-enabled-item"</span>);
  <span class="reserved">this</span>.generalMenuEnabledItem = document.getElementById(<span class="literal">"gm-general-menu-enabled-item"</span>);
  <span class="reserved">this</span>.toolsMenu = document.getElementById(<span class="literal">"menu_ToolsPopup"</span>);
  <span class="reserved">this</span>.bundle = document.getElementById(<span class="literal">"gm-browser-bundle"</span>);

  <span class="comment">// seamonkey compat</span>
  <span class="reserved">if</span> (!<span class="reserved">this</span>.toolsMenu) {
    <span class="reserved">this</span>.toolsMenu = document.getElementById(<span class="literal">"taskPopup"</span>);
  }

  <span class="comment">// songbird compat</span>
  <span class="reserved">if</span> (!<span class="reserved">this</span>.appContent &amp;&amp; <span class="reserved">this</span>.tabBrowser) {
    <span class="reserved">this</span>.appContent = <span class="reserved">this</span>.tabBrowser.parentNode;
  }

  <span class="comment">// update visual status when enabled state changes</span>
  <span class="reserved">this</span>.enabledWatcher = GM_hitch(<span class="reserved">this</span>, <span class="literal">"refreshStatus"</span>);
  GM_prefRoot.watch(<span class="literal">"enabled"</span>, <span class="reserved">this</span>.enabledWatcher);

  <span class="comment">// hook various events</span>
  GM_listen(<span class="reserved">this</span>.appContent, <span class="literal">"DOMContentLoaded"</span>, GM_hitch(<span class="reserved">this</span>, <span class="literal">"contentLoad"</span>));
  GM_listen(<span class="reserved">this</span>.contextMenu, <span class="literal">"popupshowing"</span>, GM_hitch(<span class="reserved">this</span>, <span class="literal">"contextMenuShowing"</span>));
  GM_listen(<span class="reserved">this</span>.toolsMenu, <span class="literal">"popupshowing"</span>, GM_hitch(<span class="reserved">this</span>, <span class="literal">"toolsMenuShowing"</span>));

  <span class="comment">// listen for clicks on the install bar</span>
  Components.classes[<span class="literal">"@mozilla.org/observer-service;1"</span>]
            .getService(Components.interfaces.nsIObserverService)
            .addObserver(<span class="reserved">this</span>, <span class="literal">"install-userscript"</span>, true);

  <span class="comment">// we use this to determine if we are the active window sometimes</span>
  <span class="reserved">this</span>.winWat = Components.classes[<span class="literal">"@mozilla.org/embedcomp/window-watcher;1"</span>]
                          .getService(Components.interfaces.nsIWindowWatcher);

  <span class="comment">// this gives us onLocationChange</span>
  <span class="reserved">this</span>.tabBrowser.addProgressListener(<span class="reserved">this</span>,
    Components.interfaces.nsIWebProgress.NOTIFY_LOCATION);

  <span class="comment">// update enabled icon</span>
  <span class="reserved">this</span>.refreshStatus();

  <span class="comment">// register for notifications from greasemonkey-service about ui type things</span>
  <span class="reserved">this</span>.gmSvc = Components.classes[<span class="literal">"@webmonkey.info/webmonkey-service;1"</span>]
               .getService().wrappedJSObject;
};

<span class="comment">/**
 * registerMenuCommand
 */</span>
GM_BrowserUI.registerMenuCommand = <span class="reserved">function</span>(unsafeWin, commandName, callback,
                                            accelKey, accelModifiers,
                                            accessKey) {
  var commander = <span class="reserved">this</span>.getCommander(unsafeWinw);
  commander.registerMenuCommand(commandName, callback, accelKey,
                                accelModifiers, accessKey);
};

<span class="comment">/**
 * openInTab
 */</span>
GM_BrowserUI.openInTab = <span class="reserved">function</span>(url) {
  <span class="reserved">this</span>.tabBrowser.addTab(url);
};

<span class="comment">/**
 * Gets called when a DOMContentLoaded event occurs somewhere in the browser.
 * If that document is in in the top-level window of the focused tab, find
 * it's menu items and activate them.
 */</span>
GM_BrowserUI.contentLoad = <span class="reserved">function</span>(e) {
  var safeWin;
  var unsafeWin;
  var href;
  var commander;

  <span class="reserved">if</span> (!GM_getEnabled()) {
    <span class="reserved">return</span>;
  }

  safeWin = e.target.defaultView;
  unsafeWin = safeWin.wrappedJSObject;
  href = safeWin.location.href;

  <span class="reserved">if</span> (GM_isGreasemonkeyable(href)) {
    commander = <span class="reserved">this</span>.getCommander(unsafeWin);

    <span class="comment">// if this content load is in the focused tab, attach the menuCommaander</span>
    <span class="reserved">if</span> (unsafeWin == <span class="reserved">this</span>.tabBrowser.selectedBrowser.contentWindow) {
      <span class="reserved">this</span>.currentMenuCommander = commander;
      <span class="reserved">this</span>.currentMenuCommander.attach();
    }

    <span class="reserved">this</span>.gmSvc.domContentLoaded(unsafeWin, window, <span class="reserved">this</span>);

    GM_listen(unsafeWin, <span class="literal">"pagehide"</span>, GM_hitch(<span class="reserved">this</span>, <span class="literal">"contentUnload"</span>));
  }

  <span class="comment">// Show the greasemonkey install banner if we are navigating to a .user.js</span>
  <span class="comment">// file in a top-level tab.</span>
  <span class="reserved">if</span> (href.match(/\.user\.js$/) &amp;&amp; safeWin == safeWin.top) {
    var browser = <span class="reserved">this</span>.tabBrowser.getBrowserForDocument(safeWin.document);
    <span class="reserved">this</span>.showInstallBanner(browser);
  }
};


<span class="comment">/**
 * Shows the install banner across the top of the tab that is displayed when
 * a user selects "show script source" in the install dialog.
 */</span>
GM_BrowserUI.showInstallBanner = <span class="reserved">function</span>(browser) {
  var greeting = <span class="reserved">this</span>.bundle.getString(<span class="literal">"greeting.msg"</span>);

  <span class="reserved">if</span> (<span class="reserved">this</span>.tabBrowser.showMessage) {
    <span class="comment">// Firefox 1.5 and lower</span>
    <span class="reserved">this</span>.tabBrowser.showMessage(
      browser,
      <span class="literal">"chrome://webmonkey/content/icons/icon_small.png"</span>,
      greeting,
      <span class="reserved">this</span>.bundle.getString(<span class="literal">"greeting.btn"</span>),
      null <span class="comment">/* default doc shell */</span>,
      <span class="literal">"install-userscript"</span>,
      null <span class="comment">/* no popuup */</span>,
      <span class="literal">"top"</span>,
      true <span class="comment">/* show close button */</span>,
      <span class="reserved">this</span>.bundle.getString(<span class="literal">"greeting.btnAccess"</span>) <span class="comment">/* access key */</span>);
  } <span class="reserved">else</span> {
    <span class="comment">// Firefox 2.0+</span>
    var notificationBox = <span class="reserved">this</span>.tabBrowser.getNotificationBox(browser);

    <span class="comment">// Remove existing notifications. Notifications get removed</span>
    <span class="comment">// automatically onclick and on page navigation, but we need to remove</span>
    <span class="comment">// them ourselves in the case of reload, or they stack up.</span>
    <span class="reserved">for</span> (var i = 0, child; child = notificationBox.childNodes[i]; i++) {
      <span class="reserved">if</span> (child.getAttribute(<span class="literal">"value"</span>) == <span class="literal">"install-userscript"</span>) {
        notificationBox.removeNotification(child);
      }
    }

    var notification = notificationBox.appendNotification(
      greeting,
      <span class="literal">"install-userscript"</span>,
      <span class="literal">"chrome://webmonkey/content/icons/icon_small.png"</span>,
      notificationBox.PRIORITY_WARNING_MEDIUM,
      [{
        label: <span class="reserved">this</span>.bundle.getString(<span class="literal">"greeting.btn"</span>),
        accessKey: <span class="reserved">this</span>.bundle.getString(<span class="literal">"greeting.btnAccess"</span>),
        popup: null,
        callback: GM_hitch(<span class="reserved">this</span>, <span class="literal">"installCurrentScript"</span>)
      }]
    );
  }
};

<span class="comment">/**
 * Called from greasemonkey service when we should load a user script.
 */</span>
GM_BrowserUI.startInstallScript = <span class="reserved">function</span>(uri, timer) {
  <span class="reserved">if</span> (!timer) {
    <span class="comment">// docs for nsicontentpolicy say we're not supposed to block, so short</span>
    <span class="comment">// timer.</span>
    window.setTimeout(
      <span class="reserved">function</span>() { GM_BrowserUI.startInstallScript(uri, true) }, 0);

    <span class="reserved">return</span>;
  }

  <span class="reserved">this</span>.scriptDownloader_ = new ScriptDownloader(window, uri, <span class="reserved">this</span>.bundle);
  <span class="reserved">this</span>.scriptDownloader_.startInstall();
};


<span class="comment">/**
 * Open the tab to show the contents of a script and display the banner to let
 * the user install it.
 */</span>
GM_BrowserUI.showScriptView = <span class="reserved">function</span>(scriptDownloader) {
  <span class="reserved">this</span>.scriptDownloader_ = scriptDownloader;

  var tab = <span class="reserved">this</span>.tabBrowser.addTab(scriptDownloader.script.previewURL);
  var browser = <span class="reserved">this</span>.tabBrowser.getBrowserForTab(tab);

  <span class="reserved">this</span>.tabBrowser.selectedTab = tab;
};

<span class="comment">/**
 * Implements nsIObserve.observe. Right now we're only observing our own
 * install-userscript, which happens when the install bar is clicked.
 */</span>
GM_BrowserUI.observe = <span class="reserved">function</span>(subject, topic, data) {
  <span class="reserved">if</span> (topic == <span class="literal">"install-userscript"</span>) {
    <span class="reserved">if</span> (window == <span class="reserved">this</span>.winWat.activeWindow) {
      <span class="reserved">this</span>.installCurrentScript();
    }
  } <span class="reserved">else</span> {
    throw new Error(<span class="literal">"Unexpected topic received: {"</span> + topic + <span class="literal">"}"</span>);
  }
};

<span class="comment">/**
 * Handles the install button getting clicked.
 */</span>
GM_BrowserUI.installCurrentScript = <span class="reserved">function</span>() {
  <span class="reserved">this</span>.scriptDownloader_.installScript();
};

GM_BrowserUI.installScript = <span class="reserved">function</span>(script){
  GM_getConfig().install(script);
  <span class="reserved">this</span>.showHorrayMessage(script.name);
};

<span class="comment">/**
 * The browser's location has changed. Usually, we don't care. But in the case
 * of tab switching we need to change the list of commands displayed in the
 * User Script Commands submenu.
 */</span>
GM_BrowserUI.onLocationChange = <span class="reserved">function</span>(a,b,c) {
  <span class="reserved">if</span> (<span class="reserved">this</span>.currentMenuCommander != null) {
    <span class="reserved">this</span>.currentMenuCommander.detach();
    <span class="reserved">this</span>.currentMenuCommander = null;
  }

  var menuCommander = <span class="reserved">this</span>.getCommander(<span class="reserved">this</span>.tabBrowser.selectedBrowser.
                                        contentWindow);

  <span class="reserved">if</span> (menuCommander) {
    <span class="reserved">this</span>.currentMenuCommander = menuCommander;
    <span class="reserved">this</span>.currentMenuCommander.attach();
  }
};

<span class="comment">/**
 * A content document has unloaded. We need to remove it's menuCommander to
 * avoid leaking it's memory.
 */</span>
GM_BrowserUI.contentUnload = <span class="reserved">function</span>(e) {
  <span class="reserved">if</span> (e.persisted) {
    <span class="reserved">return</span>;
  }

  var unsafeWin = e.target.defaultView;

  <span class="comment">// remove the commander for this document</span>
  var commander = null;

  <span class="comment">// looping over commanders rather than using getCommander because we need</span>
  <span class="comment">// the index into commanders.splice.</span>
  <span class="reserved">for</span> (var i = 0; item = <span class="reserved">this</span>.menuCommanders[i]; i++) {
    <span class="reserved">if</span> (item.win == unsafeWin) {

      <span class="reserved">if</span> (item.commander == <span class="reserved">this</span>.currentMenuCommander) {
        <span class="reserved">this</span>.currentMenuCommander.detach();
        <span class="reserved">this</span>.currentMenuCommander = null;
      }

      <span class="reserved">this</span>.menuCommanders.splice(i, 1);

      break;
    }
  }
};

<span class="comment">/**
 * The browser XUL has unloaded. We need to let go of the pref watcher so
 * that a non-existant window is not informed when greasemonkey enabled state
 * changes. And we need to let go of the progress listener so that we don't
 * leak it's memory.
 */</span>
GM_BrowserUI.chromeUnload = <span class="reserved">function</span>() {
  GM_prefRoot.unwatch(<span class="literal">"enabled"</span>, <span class="reserved">this</span>.enabledWatcher);
  <span class="reserved">this</span>.tabBrowser.removeProgressListener(<span class="reserved">this</span>);
  delete <span class="reserved">this</span>.menuCommanders;
};

<span class="comment">/**
 * Called when the content area context menu is showing. We figure out whether
 * to show our context items.
 */</span>
GM_BrowserUI.contextMenuShowing = <span class="reserved">function</span>() {
  var contextItem = ge(<span class="literal">"view-userscript"</span>);
  var contextSep = ge(<span class="literal">"install-userscript-sep"</span>);

  var culprit = document.popupNode;

  <span class="reserved">while</span> (culprit &amp;&amp; culprit.tagName &amp;&amp; culprit.tagName.toLowerCase() != <span class="literal">"a"</span>) {
     culprit = culprit.parentNode;
  }

  contextItem.hidden =
    contextSep.hidden =
    !<span class="reserved">this</span>.getUserScriptLinkUnderPointer();
};


GM_BrowserUI.getUserScriptLinkUnderPointer = <span class="reserved">function</span>() {
  var culprit = document.popupNode;

  <span class="reserved">while</span> (culprit &amp;&amp; culprit.tagName &amp;&amp; culprit.tagName.toLowerCase() != <span class="literal">"a"</span>) {
     culprit = culprit.parentNode;
  }

  <span class="reserved">if</span> (!culprit || !culprit.href ||
      !culprit.href.match(/\.user\.js(\?|$)/i)) {
    <span class="reserved">return</span> null;
  }

  var ioSvc = Components.classes[<span class="literal">"@mozilla.org/network/io-service;1"</span>]
                        .getService(Components.interfaces.nsIIOService);
  var uri = ioSvc.newURI(culprit.href, null, null);

  <span class="reserved">return</span> uri;
};

GM_BrowserUI.toolsMenuShowing = <span class="reserved">function</span>() {
  var installItem = ge(<span class="literal">"userscript-tools-install"</span>);
  var hidden = true;

  <span class="reserved">if</span> (window._content &amp;&amp; window._content.location &amp;&amp;
      window.content.location.href.match(/\.user\.js(\?|$)/i)) {
    hidden = false;
  }

  <span class="comment">// Better to use hidden than collapsed because collapsed still allows you to</span>
  <span class="comment">// select the item using keyboard navigation, but hidden doesn't.</span>
  installItem.setAttribute(<span class="literal">"hidden"</span>, hidden.toString());
};


<span class="comment">/**
 * Helper method which gets the menuCommander corresponding to a given
 * document
 */</span>
GM_BrowserUI.getCommander = <span class="reserved">function</span>(unsafeWin) {
  <span class="reserved">for</span> (var i = 0; i &lt; <span class="reserved">this</span>.menuCommanders.length; i++) {
    <span class="reserved">if</span> (<span class="reserved">this</span>.menuCommanders[i].win == unsafeWin) {
      <span class="reserved">return</span> <span class="reserved">this</span>.menuCommanders[i].commander;
    }
  }

  <span class="comment">// no commander found. create one and add it.</span>
  var commander = new GM_MenuCommander(document);
  <span class="reserved">this</span>.menuCommanders.push({win:unsafeWin, commander:commander});

  <span class="reserved">return</span> commander;
};

<span class="comment">/**
 * Helper to determine if a given dom window is in this tabbrowser
 */</span>
GM_BrowserUI.isMyWindow = <span class="reserved">function</span>(domWindow) {
  var tabbrowser = getBrowser();
  var browser;

  <span class="reserved">for</span> (var i = 0; browser = tabbrowser.browsers[i]; i++) {
    <span class="reserved">if</span> (browser.contentWindow == domWindow) {
      <span class="reserved">return</span> true;
    }
  }

  <span class="reserved">return</span> false;
};

<span class="reserved">function</span> GM_showGeneralPopup(aEvent) {
  <span class="comment">// set the enabled/disabled state</span>
  GM_BrowserUI.generalMenuEnabledItem.setAttribute(<span class="literal">"checked"</span>, GM_getEnabled());
}

<span class="reserved">function</span> GM_showPopup(aEvent) {
  <span class="reserved">function</span> urlsOfAllFrames(contentWindow) {
    <span class="reserved">function</span> collect(contentWindow) {
      urls = urls.concat(urlsOfAllFrames(contentWindow));
    }
    var urls = [contentWindow.location.href];
    Array.<span class="reserved">prototype</span>.slice.call(contentWindow.frames).forEach(collect);
    <span class="reserved">return</span> urls;
  }

  <span class="reserved">function</span> uniq(a) {
    var seen = {}, list = [], item;
    <span class="reserved">for</span> (var i = 0; i &lt; a.length; i++) {
      item = a[i];
      <span class="reserved">if</span> (!seen.hasOwnProperty(item))
        seen[item] = list.push(item);
    }
    <span class="reserved">return</span> list;
  }

  <span class="reserved">function</span> scriptsMatching(urls) {

    <span class="reserved">function</span> testMatchURLs(script) {

      <span class="reserved">function</span> testMatchURL(url) {
        <span class="reserved">return</span> script.matchesURL(url);
      }

      <span class="reserved">return</span> urls.some(testMatchURL);
    }

    <span class="reserved">return</span> GM_getConfig().getMatchingScripts(testMatchURLs);
  }

  <span class="reserved">function</span> appendScriptToPopup(script) {
    var mi = document.createElement(<span class="literal">"menuitem"</span>);
    mi.setAttribute(<span class="literal">"label"</span>, script.name);
    mi.script = script;
    mi.setAttribute(<span class="literal">"type"</span>, <span class="literal">"checkbox"</span>);
    mi.setAttribute(<span class="literal">"checked"</span>, script.enabled.toString());
    popup.insertBefore(mi, tail);
  }

  var popup = aEvent.target;
  var tail = document.getElementById(<span class="literal">"gm-status-no-scripts-sep"</span>);

  <span class="comment">// set the enabled/disabled state</span>
  GM_BrowserUI.statusEnabledItem.setAttribute(<span class="literal">"checked"</span>, GM_getEnabled());

  <span class="comment">// remove all the scripts from the list</span>
  <span class="reserved">for</span> (var i = popup.childNodes.length - 1; i &gt;= 0; i--) {
    var node = popup.childNodes[i];
    <span class="reserved">if</span> (node.script || node.getAttribute(<span class="literal">"value"</span>) == <span class="literal">"hack"</span>) {
      popup.removeChild(node);
    }
  }

  var urls = uniq( urlsOfAllFrames( getBrowser().contentWindow ));
  var runsOnTop = scriptsMatching( [urls.shift()] ); <span class="comment">// first url = top window</span>
  var runsFramed = scriptsMatching( urls ); <span class="comment">// remainder are all its subframes</span>

  <span class="comment">// drop all runsFramed scripts already present in runsOnTop</span>
  <span class="reserved">for</span> (var i = 0; i &lt; runsOnTop.length; i++) {
    var j = 0, item = runsOnTop[i];
    <span class="reserved">while</span> (j &lt; runsFramed.length) {
      <span class="reserved">if</span> (item === runsFramed[j]) {
        runsFramed.splice(j, 1);
      } <span class="reserved">else</span> {
        j++;
      }
    }
  }

  <span class="comment">// build the new list of scripts</span>
  <span class="reserved">if</span> (runsFramed.length) {
    runsFramed.forEach(appendScriptToPopup);
    <span class="reserved">if</span> (runsOnTop.length) { <span class="comment">// only add the separator if there is stuff below</span>
      var separator = document.createElement(<span class="literal">"menuseparator"</span>);
      separator.setAttribute(<span class="literal">"value"</span>, <span class="literal">"hack"</span>); <span class="comment">// remove it in the loop above</span>
      popup.insertBefore(separator, tail);
    }
  }
  runsOnTop.forEach(appendScriptToPopup);

  var foundInjectedScript = !!(runsFramed.length + runsOnTop.length);
  document.getElementById(<span class="literal">"gm-status-no-scripts"</span>).collapsed = foundInjectedScript;
}

<span class="comment">/**
 * Handle clicking one of the items in the popup. Left-click toggles the enabled
 * state, rihgt-click opens in an editor.
 */</span>
<span class="reserved">function</span> GM_popupClicked(aEvent) {
  <span class="reserved">if</span> (aEvent.button == 0 || aEvent.button == 2) {
    var script = aEvent.target.script;
    <span class="reserved">if</span> (!script) <span class="reserved">return</span>;

    <span class="reserved">if</span> (aEvent.button == 0) <span class="comment">// left-click: toggle enabled state</span>
      script.enabled =! script.enabled;
    <span class="reserved">else</span> <span class="comment">// right-click: open in editor</span>
      openInEditor(script);

    closeMenus(aEvent.target);
  }
}

<span class="comment">/**
 * Greasemonkey's enabled state has changed, either as a result of clicking
 * the icon in this window, clicking it in another window, or even changing
 * the mozilla preference that backs it directly.
 */</span>
GM_BrowserUI.refreshStatus = <span class="reserved">function</span>() {
  <span class="reserved">if</span> (GM_getEnabled()) {
    <span class="reserved">this</span>.statusImage.src = <span class="literal">"chrome://webmonkey/content/icons/icon_small.png"</span>;
    <span class="reserved">this</span>.statusImage.tooltipText = <span class="reserved">this</span>.bundle.getString(<span class="literal">"tooltip.enabled"</span>);
  } <span class="reserved">else</span> {
    <span class="reserved">this</span>.statusImage.src = <span class="literal">"chrome://webmonkey/content/icons/icon_small_disabled.png"</span>;
    <span class="reserved">this</span>.statusImage.tooltipText = <span class="reserved">this</span>.bundle.getString(<span class="literal">"tooltip.disabled"</span>);
  }

  <span class="reserved">this</span>.statusImage.style.opacity = <span class="literal">"1.0"</span>;
};

GM_BrowserUI.newUserScript = <span class="reserved">function</span>() {
  var windowWatcher = Components
    .classes[<span class="literal">"@mozilla.org/embedcomp/window-watcher;1"</span>]
    .getService(Components.interfaces.nsIWindowWatcher);
  windowWatcher.openWindow(
    window, <span class="literal">"chrome://webmonkey/content/newscript.xul"</span>, null,
    <span class="literal">"chrome,dependent,centerscreen,resizable,dialog"</span>, null
  );
};

GM_BrowserUI.showStatus = <span class="reserved">function</span>(message, autoHide) {
  <span class="reserved">if</span> (<span class="reserved">this</span>.statusLabel.collapsed) {
    <span class="reserved">this</span>.statusLabel.collapsed = false;
  }

  message += <span class="literal">" "</span>;

  var box = document.createElement(<span class="literal">"vbox"</span>);
  var label = document.createElement(<span class="literal">"label"</span>);
  box.style.position = <span class="literal">"fixed"</span>;
  box.style.left = <span class="literal">"-10000px"</span>;
  box.style.top = <span class="literal">"-10000px"</span>;
  box.style.border = <span class="literal">"5px solid red"</span>;
  box.appendChild(label);
  document.documentElement.appendChild(box);
  label.setAttribute(<span class="literal">"value"</span>, message);

  var current = parseInt(<span class="reserved">this</span>.statusLabel.style.width);
  <span class="reserved">this</span>.statusLabel.value = message;
  var max = label.boxObject.width;

  <span class="reserved">this</span>.showAnimation = new Accelimation(<span class="reserved">this</span>.statusLabel.style,
                                          <span class="literal">"width"</span>, max, 300, 2, <span class="literal">"px"</span>);
  <span class="reserved">this</span>.showAnimation.onend = GM_hitch(<span class="reserved">this</span>, <span class="literal">"showStatusAnimationEnd"</span>, autoHide);
  <span class="reserved">this</span>.showAnimation.start();
};

GM_BrowserUI.showStatusAnimationEnd = <span class="reserved">function</span>(autoHide) {
  <span class="reserved">this</span>.showAnimation = null;

  <span class="reserved">if</span> (autoHide) {
    <span class="reserved">this</span>.setAutoHideTimer();
  }
};

GM_BrowserUI.setAutoHideTimer = <span class="reserved">function</span>() {
  <span class="reserved">if</span> (<span class="reserved">this</span>.autoHideTimer) {
    window.clearTimeout(<span class="reserved">this</span>.autoHideTimer);
  }

  <span class="reserved">this</span>.autoHideTimer = window.setTimeout(GM_hitch(<span class="reserved">this</span>, <span class="literal">"hideStatus"</span>), 3000);
};

GM_BrowserUI.hideStatusImmediately = <span class="reserved">function</span>() {
  <span class="reserved">if</span> (<span class="reserved">this</span>.showAnimation) {
    <span class="reserved">this</span>.showAnimation.stop();
    <span class="reserved">this</span>.showAnimation = null;
  }

  <span class="reserved">if</span> (<span class="reserved">this</span>.hideAnimation) {
    <span class="reserved">this</span>.hideAnimation.stop();
    <span class="reserved">this</span>.hideAnimation = null;
  }

  <span class="reserved">if</span> (<span class="reserved">this</span>.autoHideTimer) {
    window.clearTimeout(<span class="reserved">this</span>.autoHideTimer);
    <span class="reserved">this</span>.autoHideTimer = null;
  }

  <span class="reserved">this</span>.statusLabel.style.width = <span class="literal">"0"</span>;
  <span class="reserved">this</span>.statusLabel.collapsed = true;
};

GM_BrowserUI.hideStatus = <span class="reserved">function</span>() {
  <span class="reserved">if</span> (!<span class="reserved">this</span>.hideAnimation) {
    <span class="reserved">this</span>.autoHideTimer = null;
    <span class="reserved">this</span>.hideAnimation = new Accelimation(<span class="reserved">this</span>.statusLabel.style,
                                            <span class="literal">"width"</span>, 0, 300, 2, <span class="literal">"px"</span>);
    <span class="reserved">this</span>.hideAnimation.onend = GM_hitch(<span class="reserved">this</span>, <span class="literal">"hideStatusAnimationEnd"</span>);
    <span class="reserved">this</span>.hideAnimation.start();
  }
};

GM_BrowserUI.hideStatusAnimationEnd = <span class="reserved">function</span>() {
  <span class="reserved">this</span>.hideAnimation = null;
  <span class="reserved">this</span>.statusLabel.collapsed = true;
};

<span class="comment">// necessary for webProgressListener implementation</span>
GM_BrowserUI.onProgressChange = <span class="reserved">function</span>(webProgress,b,c,d,e,f){};
GM_BrowserUI.onStateChange = <span class="reserved">function</span>(a,b,c,d){};
GM_BrowserUI.onStatusChange = <span class="reserved">function</span>(a,b,c,d){};
GM_BrowserUI.onSecurityChange = <span class="reserved">function</span>(a,b,c){};
GM_BrowserUI.onLinkIconAvailable = <span class="reserved">function</span>(a){};

GM_BrowserUI.showHorrayMessage = <span class="reserved">function</span>(scriptName) {
  <span class="reserved">this</span>.showStatus(<span class="literal">"'"</span> + scriptName + <span class="literal">"' "</span> + <span class="reserved">this</span>.bundle.getString(<span class="literal">"statusbar.installed"</span>), true);
};

GM_BrowserUI.installMenuItemClicked = <span class="reserved">function</span>() {
  GM_BrowserUI.startInstallScript(
    gBrowser.currentURI
  );
};

GM_BrowserUI.viewContextItemClicked = <span class="reserved">function</span>() {
  var uri = GM_BrowserUI.getUserScriptLinkUnderPointer();

  <span class="reserved">this</span>.scriptDownloader_ = new ScriptDownloader(window, uri, <span class="reserved">this</span>.bundle);
  <span class="reserved">this</span>.scriptDownloader_.startViewScript();
};

GM_BrowserUI.manageMenuItemClicked = <span class="reserved">function</span>() {
   GM_openUserScriptManager();
};

<span class="comment">//loggify(GM_BrowserUI, "GM_BrowserUI");</span>

log(<span class="literal">"calling init..."</span>);
GM_BrowserUI.init();
</pre>
	<hr>



<!-- ========== START OF NAVBAR ========== -->
<a name="navbar_top"><!-- --></a>
<table border="0" width="100%" cellpadding="1" cellspacing="0">
<tr>
<td colspan=2 bgcolor="#EEEEFF" class="NavBarCell1">
<a name="navbar_top_firstrow"><!-- --></a>
<table border="0" cellpadding="0" cellspacing="3">
  <tr align="center" valign="top">
  
  
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-summary.html"><font class="NavBarFont1"><b>Overview</b></font></a>&nbsp;</td>
  <td bgcolor="#FFFFFF" class="NavBarCell1Rev">	&nbsp;<font class="NavBarFont1Rev"><b>File</b></font>&nbsp;</td>
  

  <td bgcolor="#FFFFFF" class="NavBarCell1"> <font class="NavBarFont1">Class</font>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-tree.html"><font class="NavBarFont1"><b>Tree</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="index-all.html"--><font class="NavBarFont1"><b>Index</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="help-doc.html"><font class="NavBarFont1"><b>Help</b></font></a>&nbsp;</td>
  </tr>
</table>
</td>
<td bgcolor="#EEEEFF" align="right" valign="top"><em>
<b>Webmonkey</b></em>
</td>
</tr>

<tr>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
&nbsp;PREV&nbsp;
&nbsp;NEXT</font></td>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
  <a href="index.html" target="_top"><b>FRAMES</b></a>  &nbsp;
&nbsp;<a href="overview-summary.html" target="_top"><b>NO FRAMES</b></a>
&nbsp;&nbsp;
<script>
  <!--
  if(window==top) {
    document.writeln('<A HREF="allclasses-noframe.html" TARGET=""><B>All Classes</B></A>');
  }
  //-->
</script>
<noscript>
<a href="allclasses-noframe.html" target=""><b>All Classes</b></a>
</noscript>
</font></td>
</tr>
</table>
<!-- =========== END OF NAVBAR =========== -->

<hr>
<font size="-1">

</font>
<div class="jsdoc_ctime">Documentation generated by <a href="http://jsdoc.sourceforge.net/" target="_parent">JSDoc</a> on Mon Mar 30 00:30:19 2009</div>
</body>
</html>
