<!doctype html public "-//W3C//DTD HTML 4.0 Frameset//EN""http://www.w3.org/TR/REC-html40/frameset.dtd">
<html>
<head>
<title>
Webmonkey Overview
</title>
<link rel ="stylesheet" type="text/css" href="stylesheet.css" title="Style">
<script>
function asd() {
	
		parent.document.title="scriptdownloader.js Overview";
	
}
</script>
</head>
<body bgcolor="white" onload="asd();">

<!-- ========== START OF NAVBAR ========== -->
<a name="navbar_top"><!-- --></a>
<table border="0" width="100%" cellpadding="1" cellspacing="0">
<tr>
<td colspan=2 bgcolor="#EEEEFF" class="NavBarCell1">
<a name="navbar_top_firstrow"><!-- --></a>
<table border="0" cellpadding="0" cellspacing="3">
  <tr align="center" valign="top">
  
  
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-summary.html"><font class="NavBarFont1"><b>Overview</b></font></a>&nbsp;</td>
  <td bgcolor="#FFFFFF" class="NavBarCell1Rev">	&nbsp;<font class="NavBarFont1Rev"><b>File</b></font>&nbsp;</td>
  

  <td bgcolor="#FFFFFF" class="NavBarCell1"> 	<font class="NavBarFont1">Class</font>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-tree.html"><font class="NavBarFont1"><b>Tree</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="index-all.html"--><font class="NavBarFont1"><b>Index</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="help-doc.html"><font class="NavBarFont1"><b>Help</b></font></a>&nbsp;</td>
  </tr>
</table>
</td>
<td bgcolor="#EEEEFF" align="right" valign="top">
<em>
<b>Webmonkey</b></em>
</td>
</tr>

<tr>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
&nbsp;PREV&nbsp;
&nbsp;NEXT</font></td>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
  <a href="index.html" target="_top"><b>FRAMES</b></a>  &nbsp;
&nbsp;<a href="overview-summary.html" target="_top"><b>NO FRAMES</b></a>
&nbsp;&nbsp;
<script>
  <!--
  if(window==top) {
    document.writeln('<A HREF="allclasses-noframe.html" TARGET=""><B>All Classes</B></A>');
  }
  //-->
</script>
<noscript>
<a href="allclasses-noframe.html" target=""><b>All Classes</b></a>
</noscript>
</font></td>
</tr>
</table>
<!-- =========== END OF NAVBAR =========== -->

<hr>
<center>
	
	   <h2>scriptdownloader.js</h2>
	
</center>

	


<h4>Summary</h4>
<p>
	
		No overview generated for 'scriptdownloader.js'<BR/><BR/>
	
</p>

<hr>


    <table border="1" cellpadding="3" cellspacing="0" width="100%">
    <tr bgcolor="#CCCCFF" class="TableHeadingColor">
    <td colspan=2><font size="+2">
    
        <b>Class Summary</b>
    
    </font></td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="NotificationCallbacks.html">NotificationCallbacks</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="PersistProgressListener.html">PersistProgressListener</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="ScriptDownloader.html">ScriptDownloader</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    </table>
    <hr/> 


<!-- ========== METHOD SUMMARY =========== -->

<!-- ========== END METHOD SUMMARY =========== -->


        <pre class="sourceview"><span class="reserved">function</span> ScriptDownloader(win, uri, bundle) {
  <span class="reserved">this</span>.win_ = win;
  <span class="reserved">this</span>.uri_ = uri;
  <span class="reserved">this</span>.bundle_ = bundle;
  <span class="reserved">this</span>.req_ = null;
  <span class="reserved">this</span>.script = null;
  <span class="reserved">this</span>.depQueue_ = [];
  <span class="reserved">this</span>.dependenciesLoaded_ = false;
  <span class="reserved">this</span>.installOnCompletion_ = false;
  <span class="reserved">this</span>.tempFiles_ = [];
}

ScriptDownloader.<span class="reserved">prototype</span>.startInstall = <span class="reserved">function</span>() {
  <span class="reserved">this</span>.installing_ = true;
  <span class="reserved">this</span>.startDownload();
};

ScriptDownloader.<span class="reserved">prototype</span>.startViewScript = <span class="reserved">function</span>(uri) {
  <span class="reserved">this</span>.installing_ = false;
  <span class="reserved">this</span>.startDownload();
};

ScriptDownloader.<span class="reserved">prototype</span>.startDownload = <span class="reserved">function</span>() {
  <span class="reserved">this</span>.win_.GM_BrowserUI.statusImage.src = <span class="literal">"chrome://global/skin/throbber/Throbber-small.gif"</span>;
  <span class="reserved">this</span>.win_.GM_BrowserUI.statusImage.style.opacity = <span class="literal">"0.5"</span>;
  <span class="reserved">this</span>.win_.GM_BrowserUI.statusImage.tooltipText = <span class="reserved">this</span>.bundle_.getString(<span class="literal">"tooltip.loading"</span>);

  <span class="reserved">this</span>.win_.GM_BrowserUI.showStatus(<span class="literal">"Fetching user script"</span>, false);

  Components.classes[<span class="literal">"@webmonkey.info/webmonkey-service;1"</span>]
    .getService().wrappedJSObject
    .ignoreNextScript();

  <span class="reserved">this</span>.req_ = new XMLHttpRequest();
  <span class="reserved">this</span>.req_.open(<span class="literal">"GET"</span>, <span class="reserved">this</span>.uri_.spec, true);
  <span class="reserved">this</span>.req_.onload = GM_hitch(<span class="reserved">this</span>, <span class="literal">"handleScriptDownloadComplete"</span>);
  <span class="reserved">this</span>.req_.send(null);
};

ScriptDownloader.<span class="reserved">prototype</span>.handleScriptDownloadComplete = <span class="reserved">function</span>() {
  <span class="reserved">this</span>.win_.GM_BrowserUI.refreshStatus();
  <span class="reserved">this</span>.win_.GM_BrowserUI.hideStatusImmediately();

  try {
    <span class="comment">// If loading from file, status might be zero on success</span>
    <span class="reserved">if</span> (<span class="reserved">this</span>.req_.status != 200 &amp;&amp; <span class="reserved">this</span>.req_.status != 0) {
      <span class="comment">// NOTE: Unlocalized string</span>
      alert(<span class="literal">"Error loading user script:\n"</span> +
      <span class="reserved">this</span>.req_.status + <span class="literal">": "</span> +
      <span class="reserved">this</span>.req_.statusText);
      <span class="reserved">return</span>;
    }

    var source = <span class="reserved">this</span>.req_.responseText;

    <span class="reserved">this</span>.script = GM_getConfig().parse(source, <span class="reserved">this</span>.uri_);

    var file = Components.classes[<span class="literal">"@mozilla.org/file/directory_service;1"</span>]
                         .getService(Components.interfaces.nsIProperties)
                         .get(<span class="literal">"TmpD"</span>, Components.interfaces.nsILocalFile);

    var base = <span class="reserved">this</span>.script.name.replace(/[^A-Z0-9_]/gi, <span class="literal">""</span>).toLowerCase();
    file.append(base + <span class="literal">".user.js"</span>);
    file.createUnique(
      Components.interfaces.nsILocalFile.NORMAL_FILE_TYPE,
      0640
    );
    <span class="reserved">this</span>.tempFiles_.push(file);

    var converter =
      Components.classes[<span class="literal">"@mozilla.org/intl/scriptableunicodeconverter"</span>]
        .createInstance(Components.interfaces.nsIScriptableUnicodeConverter);
    converter.charset = <span class="literal">"UTF-8"</span>;
    source = converter.ConvertFromUnicode(source);

    var ws = getWriteStream(file);
    ws.write(source, source.length);
    ws.close();

    <span class="reserved">this</span>.script.setDownloadedFile(file);

    window.setTimeout(GM_hitch(<span class="reserved">this</span>, <span class="literal">"fetchDependencies"</span>), 0);

    <span class="reserved">if</span>(<span class="reserved">this</span>.installing_){
      <span class="reserved">this</span>.showInstallDialog();
    }<span class="reserved">else</span>{
      <span class="reserved">this</span>.showScriptView();
    }
  } catch (e) {
    <span class="comment">// NOTE: unlocalized string</span>
    alert(<span class="literal">"Script could not be installed "</span> + e);
    throw e;
  }
};

ScriptDownloader.<span class="reserved">prototype</span>.fetchDependencies = <span class="reserved">function</span>(){
  GM_log(<span class="literal">"Fetching Dependencies"</span>);
  var deps = <span class="reserved">this</span>.script.requires.concat(<span class="reserved">this</span>.script.resources);
  <span class="reserved">for</span> (var i = 0; i &lt; deps.length; i++) {
    var dep = deps[i];
    <span class="reserved">if</span> (<span class="reserved">this</span>.checkDependencyURL(dep.urlToDownload)) {
      <span class="reserved">this</span>.depQueue_.push(dep);
    } <span class="reserved">else</span> {
      <span class="reserved">this</span>.errorInstallDependency(<span class="reserved">this</span>.script, dep,
        <span class="literal">"SecurityException: Request to local and chrome url's is forbidden"</span>);
      <span class="reserved">return</span>;
    }
  }
  <span class="reserved">this</span>.downloadNextDependency();
};

ScriptDownloader.<span class="reserved">prototype</span>.downloadNextDependency = <span class="reserved">function</span>(){
  <span class="reserved">if</span> (<span class="reserved">this</span>.depQueue_.length &gt; 0) {
    var dep = <span class="reserved">this</span>.depQueue_.pop();
    try {
      var persist = Components.classes[
        <span class="literal">"@mozilla.org/embedding/browser/nsWebBrowserPersist;1"</span>]
        .createInstance(Components.interfaces.nsIWebBrowserPersist);
      persist.persistFlags =
        persist.PERSIST_FLAGS_BYPASS_CACHE |
        persist.PERSIST_FLAGS_REPLACE_EXISTING_FILES; <span class="comment">//doesn't work?</span>
      var ioservice =
        Components.classes[<span class="literal">"@mozilla.org/network/io-service;1"</span>]
        .getService(Components.interfaces.nsIIOService);
      var sourceUri = ioservice.newURI(dep.urlToDownload, null, null);
      var sourceChannel = ioservice.newChannelFromURI(sourceUri);
      sourceChannel.notificationCallbacks = new NotificationCallbacks();

      var file = getTempFile();
      <span class="reserved">this</span>.tempFiles_.push(file);

      var progressListener = new PersistProgressListener(persist);
      progressListener.onFinish = GM_hitch(<span class="reserved">this</span>,
        <span class="literal">"handleDependencyDownloadComplete"</span>, dep, file, sourceChannel);
      persist.progressListener = progressListener;

      persist.saveChannel(sourceChannel,  file);
    } catch(e) {
      GM_log(<span class="literal">"Download exception "</span> + e);
      <span class="reserved">this</span>.errorInstallDependency(<span class="reserved">this</span>.script, dep, e);
    }
  } <span class="reserved">else</span> {
    <span class="reserved">this</span>.dependenciesLoaded_ = true;
    <span class="reserved">this</span>.finishInstall();
  }
};

ScriptDownloader.<span class="reserved">prototype</span>.handleDependencyDownloadComplete =
<span class="reserved">function</span>(dep, file, channel) {
  GM_log(<span class="literal">"Dependency Download complete "</span> + dep.urlToDownload);
  try {
    var httpChannel =
      channel.QueryInterface(Components.interfaces.nsIHttpChannel);
  } catch(e) {
    var httpChannel = false;
  }

  <span class="reserved">if</span> (httpChannel) {
    <span class="reserved">if</span> (httpChannel.requestSucceeded) {
      dep.setDownloadedFile(file, channel.contentType, channel.contentCharset ? channel.contentCharset : null);
      <span class="reserved">this</span>.downloadNextDependency();
    } <span class="reserved">else</span> {
      <span class="reserved">this</span>.errorInstallDependency(<span class="reserved">this</span>.script, dep,
        <span class="literal">"Error! Server Returned : "</span> + httpChannel.responseStatus + <span class="literal">": "</span> +
        httpChannel.responseStatusText);
    }
  } <span class="reserved">else</span> {
    dep.setDownloadedFile(file);
    <span class="reserved">this</span>.downloadNextDependency();
  }
};

ScriptDownloader.<span class="reserved">prototype</span>.checkDependencyURL = <span class="reserved">function</span>(url) {
  var ioService = Components.classes[<span class="literal">"@mozilla.org/network/io-service;1"</span>]
                            .getService(Components.interfaces.nsIIOService);
  var scheme = ioService.extractScheme(url);

  switch (scheme) {
    case <span class="literal">"http"</span>:
    case <span class="literal">"https"</span>:
    case <span class="literal">"ftp"</span>:
        <span class="reserved">return</span> true;
    case <span class="literal">"file"</span>:
        var scriptScheme = ioService.extractScheme(<span class="reserved">this</span>.uri_.spec);
        <span class="reserved">return</span> (scriptScheme == <span class="literal">"file"</span>)
    default:
      <span class="reserved">return</span> false;
  }
};

ScriptDownloader.<span class="reserved">prototype</span>.finishInstall = <span class="reserved">function</span>(){
  <span class="reserved">if</span> (<span class="reserved">this</span>.installOnCompletion_) {
    <span class="reserved">this</span>.installScript();
  }
};

ScriptDownloader.<span class="reserved">prototype</span>.errorInstallDependency = <span class="reserved">function</span>(script, dep, msg){
  GM_log(<span class="literal">"Error loading dependency "</span> + dep.urlToDownload + <span class="literal">"\n"</span> + msg)
  <span class="reserved">if</span> (<span class="reserved">this</span>.installOnCompletion_) {
    alert(<span class="literal">"Error loading dependency "</span> + dep.urlToDownload + <span class="literal">"\n"</span> + msg);
  } <span class="reserved">else</span> {
    <span class="reserved">this</span>.dependencyError = <span class="literal">"Error loading dependency "</span> + dep.urlToDownload + <span class="literal">"\n"</span> + msg;
  }
};

ScriptDownloader.<span class="reserved">prototype</span>.installScript = <span class="reserved">function</span>(){
  <span class="reserved">if</span> (<span class="reserved">this</span>.dependencyError) {
    alert(<span class="reserved">this</span>.dependencyError);
  } <span class="reserved">else</span> <span class="reserved">if</span>(<span class="reserved">this</span>.dependenciesLoaded_) {
    <span class="reserved">this</span>.win_.GM_BrowserUI.installScript(<span class="reserved">this</span>.script)
  } <span class="reserved">else</span> {
    <span class="reserved">this</span>.installOnCompletion_ = true;
  }
};

ScriptDownloader.<span class="reserved">prototype</span>.cleanupTempFiles = <span class="reserved">function</span>() {
  <span class="reserved">for</span> (var i = 0, file = null; file = <span class="reserved">this</span>.tempFiles_[i]; i++) {
    file.remove(false);
  }
};

ScriptDownloader.<span class="reserved">prototype</span>.showInstallDialog = <span class="reserved">function</span>(timer) {
  <span class="reserved">if</span> (!timer) {
    <span class="comment">// otherwise, the status bar stays in the loading state.</span>
    <span class="reserved">this</span>.win_.setTimeout(GM_hitch(<span class="reserved">this</span>, <span class="literal">"showInstallDialog"</span>, true), 0);
    <span class="reserved">return</span>;
  }
  <span class="reserved">this</span>.win_.openDialog(<span class="literal">"chrome://webmonkey/content/install.xul"</span>, <span class="literal">""</span>,
                       <span class="literal">"chrome,centerscreen,modal,dialog,titlebar,resizable"</span>,
                       <span class="reserved">this</span>);
};

ScriptDownloader.<span class="reserved">prototype</span>.showScriptView = <span class="reserved">function</span>() {
  <span class="reserved">this</span>.win_.GM_BrowserUI.showScriptView(<span class="reserved">this</span>);
};

<span class="reserved">function</span> NotificationCallbacks() {}

NotificationCallbacks.<span class="reserved">prototype</span>.QueryInterface = <span class="reserved">function</span>(aIID) {
  <span class="reserved">if</span> (aIID.equals(Components.interfaces.nsIInterfaceRequestor)) {
    <span class="reserved">return</span> <span class="reserved">this</span>;
  }
  throw Components.results.NS_NOINTERFACE;
};

NotificationCallbacks.<span class="reserved">prototype</span>.getInterface = <span class="reserved">function</span>(aIID) {
  <span class="reserved">if</span> (aIID.equals(Components.interfaces.nsIAuthPrompt )) {
     var winWat = Components.classes[<span class="literal">"@mozilla.org/embedcomp/window-watcher;1"</span>]
                            .getService(Components.interfaces.nsIWindowWatcher);
     <span class="reserved">return</span> winWat.getNewAuthPrompter(winWat.activeWindow);
  }
  <span class="reserved">return</span> undefined;
};


<span class="reserved">function</span> PersistProgressListener(persist) {
  <span class="reserved">this</span>.persist = persist;
  <span class="reserved">this</span>.onFinish = <span class="reserved">function</span>(){};
  <span class="reserved">this</span>.persiststate = <span class="literal">""</span>;
}

PersistProgressListener.<span class="reserved">prototype</span>.QueryInterface = <span class="reserved">function</span>(aIID) {
 <span class="reserved">if</span> (aIID.equals(Components.interfaces.nsIWebProgressListener)) {
   <span class="reserved">return</span> <span class="reserved">this</span>;
 }
 throw Components.results.NS_NOINTERFACE;
};

<span class="comment">// nsIWebProgressListener</span>
PersistProgressListener.<span class="reserved">prototype</span>.onProgressChange =
  PersistProgressListener.<span class="reserved">prototype</span>.onLocationChange =
    PersistProgressListener.<span class="reserved">prototype</span>.onStatusChange =
      PersistProgressListener.<span class="reserved">prototype</span>.onSecurityChange = <span class="reserved">function</span>(){};

PersistProgressListener.<span class="reserved">prototype</span>.onStateChange =
  <span class="reserved">function</span>(aWebProgress, aRequest, aStateFlags, aStatus) {
    <span class="reserved">if</span> (<span class="reserved">this</span>.persist.currentState == <span class="reserved">this</span>.persist.PERSIST_STATE_FINISHED) {
      GM_log(<span class="literal">"Persister: Download complete "</span> + aRequest.status);
      <span class="reserved">this</span>.onFinish();
    }
  };
</pre>
	<hr>



<!-- ========== START OF NAVBAR ========== -->
<a name="navbar_top"><!-- --></a>
<table border="0" width="100%" cellpadding="1" cellspacing="0">
<tr>
<td colspan=2 bgcolor="#EEEEFF" class="NavBarCell1">
<a name="navbar_top_firstrow"><!-- --></a>
<table border="0" cellpadding="0" cellspacing="3">
  <tr align="center" valign="top">
  
  
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-summary.html"><font class="NavBarFont1"><b>Overview</b></font></a>&nbsp;</td>
  <td bgcolor="#FFFFFF" class="NavBarCell1Rev">	&nbsp;<font class="NavBarFont1Rev"><b>File</b></font>&nbsp;</td>
  

  <td bgcolor="#FFFFFF" class="NavBarCell1"> <font class="NavBarFont1">Class</font>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-tree.html"><font class="NavBarFont1"><b>Tree</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="index-all.html"--><font class="NavBarFont1"><b>Index</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="help-doc.html"><font class="NavBarFont1"><b>Help</b></font></a>&nbsp;</td>
  </tr>
</table>
</td>
<td bgcolor="#EEEEFF" align="right" valign="top"><em>
<b>Webmonkey</b></em>
</td>
</tr>

<tr>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
&nbsp;PREV&nbsp;
&nbsp;NEXT</font></td>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
  <a href="index.html" target="_top"><b>FRAMES</b></a>  &nbsp;
&nbsp;<a href="overview-summary.html" target="_top"><b>NO FRAMES</b></a>
&nbsp;&nbsp;
<script>
  <!--
  if(window==top) {
    document.writeln('<A HREF="allclasses-noframe.html" TARGET=""><B>All Classes</B></A>');
  }
  //-->
</script>
<noscript>
<a href="allclasses-noframe.html" target=""><b>All Classes</b></a>
</noscript>
</font></td>
</tr>
</table>
<!-- =========== END OF NAVBAR =========== -->

<hr>
<font size="-1">

</font>
<div class="jsdoc_ctime">Documentation generated by <a href="http://jsdoc.sourceforge.net/" target="_parent">JSDoc</a> on Mon Mar 30 00:30:19 2009</div>
</body>
</html>
